<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kyle Nessen">
<meta name="dcterms.date" content="2024-02-07">

<title>SelecTree - Common Names Continued, Embeddings</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">SelecTree</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Common Names Continued, Embeddings</h1>
            <p class="subtitle lead">Week 4</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Kyle Nessen </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 7, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#previous-week-notes" id="toc-previous-week-notes" class="nav-link active" data-scroll-target="#previous-week-notes">Previous week notes</a></li>
  <li><a href="#clean-up-notes" id="toc-clean-up-notes" class="nav-link" data-scroll-target="#clean-up-notes">Clean up notes</a></li>
  <li><a href="#embeddings" id="toc-embeddings" class="nav-link" data-scroll-target="#embeddings">Embeddings</a>
  <ul class="collapse">
  <li><a href="#other-uses-for-embedding" id="toc-other-uses-for-embedding" class="nav-link" data-scroll-target="#other-uses-for-embedding">Other uses for embedding</a></li>
  </ul></li>
  <li><a href="#synonyms" id="toc-synonyms" class="nav-link" data-scroll-target="#synonyms">Synonyms</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="previous-week-notes" class="level2">
<h2 class="anchored" data-anchor-id="previous-week-notes">Previous week notes</h2>
<ul>
<li>Matt was happy to include as many common names as possible.</li>
<li>I said I would go through and do some more clean up before shipping a completed list to Logan.</li>
<li>Matt wanted me to keep in mind the project to create our own name parser for urban trees.</li>
</ul>
</section>
<section id="clean-up-notes" class="level2">
<h2 class="anchored" data-anchor-id="clean-up-notes">Clean up notes</h2>
<p>Last week I presented <code>9,988</code> common names for all SelecTree species. This includes existing and new names from GBIF. However, a quick inspection indicated that a lot of those names are false duplicates. For example <strong>WHITE FIR</strong> and <strong>WHITE-FIR</strong> may look different to the computer, but are actually essentially duplicates of the same name. For the dashed names, I reviewed about 300 names before making the call to do a find a replace on the whole dataset. This dropped the total names by about <code>~3,000</code> alone.</p>
<p>There were also some other anomalies from GBIF, including multiple names separated by a comma on the same line. I dealt with these as well.</p>
<p>Some of the existing common names had a mix of upper and lower case. I’ve fixed that in this iteration so all names are now upper case.</p>
<p>In the end, this brought the total number of names (both existing and new) down to <code>6,518</code>. Much better!</p>
</section>
<section id="embeddings" class="level2">
<h2 class="anchored" data-anchor-id="embeddings">Embeddings</h2>
<p>Not content to leave it there, I used AI to help surface additional duplicate names.</p>
<p>I did this by using <a href="https://en.wikipedia.org/wiki/Word_embedding">word embedding</a> to essentially translate the common name to a numerical vector. This allows me to calculate the similarity to other common names as a single score between 0 (no similarity) and 1 (identical).</p>
<p>It’s important to note that this is a semantic similarity, which goes deeper than surface level comparisons. For example, <strong>DUTCH ELM</strong> and <strong>HOLLAND ELM</strong> have a similarity score of <code>0.89</code>. While <strong>PUNK TREE</strong> and <strong>MELALEUCA</strong> have a similarity score of <code>0.21</code>.</p>
<p>Here’s a random sample of 25 common names and their most similar pair.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 27%">
<col style="width: 28%">
<col style="width: 26%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Scientific Name</th>
<th style="text-align: left;">Common Name</th>
<th style="text-align: left;">Most Similar Name</th>
<th style="text-align: right;">Similarity Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Agathis robusta</td>
<td style="text-align: left;">AUSTRALIAN KAURI</td>
<td style="text-align: left;">SMOOTHBARK KAURI</td>
<td style="text-align: right;">0.5556556</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cotoneaster salicifolius</td>
<td style="text-align: left;">WILLOW LEAVED COTONEASTER</td>
<td style="text-align: left;">WILLOW LEAF COTONEASTER</td>
<td style="text-align: right;">0.9353113</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Malus sylvestris</td>
<td style="text-align: left;">EUROPEAN CRAB APPLE</td>
<td style="text-align: left;">EUROPEAN WILD APPLE</td>
<td style="text-align: right;">0.7778924</td>
</tr>
<tr class="even">
<td style="text-align: left;">Syzygium cumini</td>
<td style="text-align: left;">PORTUGUESE PLUM</td>
<td style="text-align: left;">DUBAT</td>
<td style="text-align: right;">0.2633872</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Corymbia citriodora</td>
<td style="text-align: left;">LEMON SCENT GUM</td>
<td style="text-align: left;">LEMON SCENTED GUM</td>
<td style="text-align: right;">0.9833951</td>
</tr>
<tr class="even">
<td style="text-align: left;">Amelanchier canadensis</td>
<td style="text-align: left;">EASTERN SERVICEBERRY</td>
<td style="text-align: left;">CANADIAN SERVICEBERRY</td>
<td style="text-align: right;">0.6838179</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Moringa oleifera</td>
<td style="text-align: left;">DRUMSTICKTREE</td>
<td style="text-align: left;">HORSERADISHTREE</td>
<td style="text-align: right;">0.4749083</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cornus florida</td>
<td style="text-align: left;">FLORIDA DOGWOOD</td>
<td style="text-align: left;">WHITE CORNEL</td>
<td style="text-align: right;">0.3870133</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Casuarina equisetifolia</td>
<td style="text-align: left;">SHE OAK</td>
<td style="text-align: left;">POLYNESIAN IRONWOOD</td>
<td style="text-align: right;">0.4099975</td>
</tr>
<tr class="even">
<td style="text-align: left;">Quercus turbinella</td>
<td style="text-align: left;">SONORAN SCRUB OAK</td>
<td style="text-align: left;">DESERT SCRUB OAK</td>
<td style="text-align: right;">0.7632381</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Aleurites moluccanus</td>
<td style="text-align: left;">CANDLEBERRY</td>
<td style="text-align: left;">LUMBANG</td>
<td style="text-align: right;">0.2996362</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ficus aurea</td>
<td style="text-align: left;">FLORIDA STRANGLER FIG</td>
<td style="text-align: left;">GOLDEN FIG</td>
<td style="text-align: right;">0.4919955</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Agonis flexuosa</td>
<td style="text-align: left;">WESTERN AUSTRALIAN MYRTLE</td>
<td style="text-align: left;">WILLOW PEPPERMINT</td>
<td style="text-align: right;">0.4268756</td>
</tr>
<tr class="even">
<td style="text-align: left;">Thespesia populnea</td>
<td style="text-align: left;">QUILULU</td>
<td style="text-align: left;">AMAE</td>
<td style="text-align: right;">0.2472749</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cordia sebestena</td>
<td style="text-align: left;">BROADLEAF</td>
<td style="text-align: left;">KELAU</td>
<td style="text-align: right;">0.2150219</td>
</tr>
<tr class="even">
<td style="text-align: left;">Araucaria cunninghamii</td>
<td style="text-align: left;">RICHMOND RIVER PINE</td>
<td style="text-align: left;">HOOP PINE</td>
<td style="text-align: right;">0.5784520</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Morinda citrifolia</td>
<td style="text-align: left;">NGEL</td>
<td style="text-align: left;">NOPURNEN</td>
<td style="text-align: right;">0.2878066</td>
</tr>
<tr class="even">
<td style="text-align: left;">Casuarina equisetifolia</td>
<td style="text-align: left;">WHISTLINGTREE</td>
<td style="text-align: left;">WEHKU</td>
<td style="text-align: right;">0.2106916</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Libidibia ferrea</td>
<td style="text-align: left;">MORADA</td>
<td style="text-align: left;">LEOPARD TREE</td>
<td style="text-align: right;">0.2191152</td>
</tr>
<tr class="even">
<td style="text-align: left;">Phillyrea latifolia</td>
<td style="text-align: left;">GREEN OLIVE TREE</td>
<td style="text-align: left;">MOCK PRIVET</td>
<td style="text-align: right;">0.3954378</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Syzygium malaccense</td>
<td style="text-align: left;">OTAHEITE APPLE</td>
<td style="text-align: left;">FAARIYAP</td>
<td style="text-align: right;">0.3210089</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pandanus tectorius</td>
<td style="text-align: left;">TAHITIAN SCREWPINE</td>
<td style="text-align: left;">KAFU</td>
<td style="text-align: right;">0.2487246</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lagunaria patersonia</td>
<td style="text-align: left;">WHITEWOOD</td>
<td style="text-align: left;">PRIMROSE TREE</td>
<td style="text-align: right;">0.3828147</td>
</tr>
<tr class="even">
<td style="text-align: left;">Eucalyptus bridgesiana</td>
<td style="text-align: left;">APPLEBOX</td>
<td style="text-align: left;">SWAMP APPLE</td>
<td style="text-align: right;">0.5530319</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Casuarina equisetifolia</td>
<td style="text-align: left;">BEACH CASUARINA</td>
<td style="text-align: left;">HORSETAILTREE</td>
<td style="text-align: right;">0.3071727</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>I’ve made another Google Sheet with the full list of comparison, with the most similar (and most likely to be a duplicate) at the top. I’ve also added check boxes for names that should be <strong><em>removed.</em></strong> If there’s no check box, I’ll assume it’s good to keep. If you want me to keep everything, great. Or we can review till we get tired of it. Just let me know how to proceed.</p>
<div style="text-align: center;">
    <a href="https://docs.google.com/spreadsheets/d/1RLxf8dbUFPRT7He7yXrWk8dn5Ii2xWuV2bJvK2pTOB0/edit?usp=sharing" target="_blank" style="background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 20px 40px; /* Size of the button */
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px; /* Font size */
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 12px;">SelecTree - Similar Common Names</a>
</div>
<section id="other-uses-for-embedding" class="level3">
<h3 class="anchored" data-anchor-id="other-uses-for-embedding">Other uses for embedding</h3>
<p>This may be an over-engineered solution for a list of common names, but I think it was a useful exercise. There are genuine duplicates in that list that would have been otherwise difficult to catch.</p>
<p>Additionally, embeddings can be used to do robust fuzzy matching on names inputted by users. This could be useful for our name parser service, and I don’t think any of the other common services (like <a href="https://tnrs.biendata.org/">TNRS</a>) are using this particular technique. I believe they are using older natural language processing methods.</p>
</section>
</section>
<section id="synonyms" class="level2">
<h2 class="anchored" data-anchor-id="synonyms">Synonyms</h2>
<p>Next week I’ll repeat the work I did for common names but for taxonomic synonyms. Please let me know if there’s another area I should focus.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>